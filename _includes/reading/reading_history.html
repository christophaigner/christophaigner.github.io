{% assign history = site.data.reading.history %}
{% assign allBooks = site.data.reading.history | map: "books" | map: "category" | split: "" %}

<h1>ðŸ“š Reading history</h1>
<div style="height: 15px;"></div>

<h4>Category breakdown</h4>

<div class="chart-container">
  <canvas id="reading_history_overall_breakdown_chart"></canvas>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof Chart === "undefined") return;

    let chart;

    const isDark = () => document.documentElement.getAttribute("data-theme") === "dark";

    const render = () => {
      if (chart) chart.destroy();

      const tickColor = isDark() ? "rgba(255,255,255,0.82)" : "rgba(0,0,0,0.65)";
      const gridColor = isDark() ? "rgba(255,255,255,0.12)" : "rgba(0,0,0,0.10)";
      const axisLabelColor = isDark() ? "rgba(255,255,255,0.92)" : "rgba(0,0,0,0.82)";
      const fill = isDark() ? "rgba(88, 166, 255, 0.75)" : "rgba(0, 123, 255, 0.65)";
      const border = isDark() ? "rgba(88, 166, 255, 1)" : "rgba(0, 123, 255, 0.95)";

      const ctx = document.getElementById('reading_history_overall_breakdown_chart');
      const mappedBooks = {{ allBooks }}.reduce(function (acc, curr) {
        return acc[curr] ? ++acc[curr] : acc[curr] = 1, acc
      }, {});
      const sortedBooks = Object.keys(mappedBooks).map(k => ([k, mappedBooks[k]])).sort((a, b) => (b[1] - a[1]));
      const result = Object.fromEntries(sortedBooks.map(x => [x[0], x[1]]));
      const entries = Object.entries(result);
      const topN = 10;
      const top = entries.slice(0, topN);
      const rest = entries.slice(topN);
      const otherCount = rest.reduce((acc, [, v]) => acc + v, 0);
      const labels = top.map(([k]) => k).concat(otherCount > 0 ? ["Other"] : []);
      const data = top.map(([, v]) => v).concat(otherCount > 0 ? [otherCount] : []);

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: "# of books",
            data,
            backgroundColor: fill,
            borderColor: border,
            borderWidth: 1,
            borderSkipped: false
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: "y",
          scales: {
            x: {
              ticks: { color: tickColor },
              grid: { color: gridColor },
              title: {
                display: true,
                text: "# of books",
                color: axisLabelColor
              }
            },
            y: {
              ticks: { color: tickColor },
              grid: { color: gridColor }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    };

    render();
    window.addEventListener("themechange", render);
  });
</script>

<div style="height: 15px;"></div>
<h4>History</h4>

<div class="accordion" id="reading_history">
  {% for entry in history %}
  {% assign books_count = entry.books.size %}
  <!-- Collect categories from all books -->
  {%- assign categories = blank -%}
  {% assign sorted_books = entry.books | sort: "name" %}
  {%- for book in sorted_books -%}
  {%- assign category = book.category | append:'|' -%}
  {%- assign categories = categories | append:category -%}
  {%- endfor -%}
  {%- assign categories = categories | split:'|' | uniq | sort -%}

  <div class="accordion-item">
    <h2 class="accordion-header" id="heading_{{ entry.year }}">
      <button class="accordion-button collapsed" type="button"
        data-bs-toggle="collapse"
        data-bs-target="#collapse_{{ entry.year }}"
        aria-expanded="false"
        aria-controls="collapse_{{ entry.year }}">
        {{ entry.year }} ({{ books_count }} books)
      </button>
    </h2>

    <div id="collapse_{{ entry.year }}"
      class="accordion-collapse collapse"
      aria-labelledby="heading_{{ entry.year }}"
      data-bs-parent="#reading_history">
      <div class="accordion-body">

        <!-- List categories & related books -->
        {% for category in categories %}
        <h4 class="mt-3" id="{{ category | slugify }}">{{ category }}</h4>
        <ul>
          {% for book in sorted_books %}
          {%- if book.category contains category -%}
          <li><a href="{{ book.url }}" target="_blank">{{ book.name }}</a></li>
          {%- endif -%}
          {% endfor %}
        </ul>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>